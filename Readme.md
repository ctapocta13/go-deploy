# go-deploy

## Цель

Автоматизировать выкладку изменений по задачам из версии dev на боевую

## Логика работы

Пользователь запускает команду вида

```sh
go-deploy -project=project_name -task=task_number
```

* Программа ищет в папке запуска папку project_name и переходит в нее
* Выполняет в ней `git log --pretty=oneline` и определяет commit_id
* Получает из коммита с найденным commit_id список затронутых файлов `git diff-tree --no-commit-id --name-only -r commit_id`
* Берем в папке файл с настройками в удобной нам форме (json)
* По полученному списку файлов:
  * Смотрим в целевой папке (получается из настроек, может быть локальной или удаленной) дату модификации файла
  * Если файла нет - копируем
  * Если дата модификации раньше аналогичного файла в папке с проектом - делаем его копию *.bak и заменяем его из папки с проектом
  * Если позднее - выводим сообщение, что файл не перенесен
  * Предусмотреть в настройках частный случай, когда файлы из папок src переносятся не сами, а их собранные версии. Куда переносить тоже можно брать в настройках
  * Предусмотреть возможность запуска миграций (из специальной папки migration (путь брать из настроек) файлы запускаются в корне целевого проекта. Название должно совпадать с номером задачи)
  * Может быть так, что файл удалён в коммите
  * Может быть так, что добавляются новые папки
  * Может быть так, что по одной задаче есть несколько коммитов

## Пример вывода git log --pretty=oneline

```sh
ae71608d2b5bfb91a90e4bb9d8011e8a4c5bab27 (HEAD -> master, origin/master) 204308: Правки SEO
9fbad0b8be31e557e00fde6f76cc1d50900ffaef Незакоммиченое
e050216686a41fb760bee4a694ba3ae85307f99c 200611: Искажение изображения в новостях
6d08630daaec17e66e47d5f3f07f636486e414ec 199931 Скрыть разделы
6f29ea474a75a25f2e8a6c3064cee3a143a0732d Создание репозитория
```

## Пример вывода git diff-tree --no-commit-id --name-only -r ae71608d2b5bfb91a90e4bb9d8011e8a4c5bab27

```sh
www/local/templates/mirrey/components/bitrix/news.detail/front_company/style.css
www/local/templates/mirrey/components/bitrix/news.detail/front_company/template.php
```
